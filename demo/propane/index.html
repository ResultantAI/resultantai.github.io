<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Propane Dispatch Demo | ResultantAI</title>
  <meta name="description" content="Interactive demo of ResultantAI's propane delivery dispatch software. See how to eliminate paper tickets, capture surcharges, and sync with QuickBooks.">
  
  <!-- Open Graph for LinkedIn shares -->
  <meta property="og:title" content="Propane Dispatch Software Demo | ResultantAI">
  <meta property="og:description" content="Stop the 'where is my truck' calls. See how propane companies are eliminating paper tickets and capturing $64K/year in missed surcharges.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://demo.resultantai.com/propane/">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { margin: 0; padding: 0; }
    #root { min-height: 100vh; }
    /* Hide Babel warning */
    .babel-warning { display: none !important; }
  </style>
</head>
<body>
  <div id="root">
    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #0f172a; color: white;">
      <div style="text-align: center;">
        <div style="font-size: 48px; margin-bottom: 16px;">‚õΩ</div>
        <div style="font-size: 18px;">Loading demo...</div>
      </div>
    </div>
  </div>

  <script type="text/babel" data-presets="react">

// ============================================
// V4 PROTOTYPE - WIN ALL 9 PERSONAS
// ============================================
// #1 Traditional (6 trucks) - Low cost entry
// #2 Scaler (12 trucks) - Portal + API access
// #3 Compliance (8 trucks) - SLA + Audit
// #4 Aggregator (50+ trucks) - Multi-location dashboard
// #5 Hybrid (8 trucks) - ServiceTitan webhook, Red Tag workflow
// #6 Ag Co-op (15 trucks) - Tax exemptions, Split billing
// #7 Driver (Mac) - Big buttons, meter OCR, incentives
// #8 Dispatcher (Sarah) - Compact view, hotkeys, available inventory
// #9 Acquired GM (Bob) - Leaderboard privacy, archive viewer
// #10 Enterprise Refugee (25 trucks) - Data migration, batch operations
// #11 New Entrant (1 truck) - Fresh start, profitability calculator

// ============================================
// DATA - MULTI-LOCATION
// ============================================
const BRANCHES = [
  { id: 1, name: 'Pennsylvania', code: 'PA', trucks: 12, customers: 1847, revenue: 2847500, target: 3000000 },
  { id: 2, name: 'Ohio', code: 'OH', trucks: 8, customers: 1203, revenue: 1923000, target: 2000000 },
  { id: 3, name: 'West Virginia', code: 'WV', trucks: 4, customers: 542, revenue: 687000, target: 800000 },
  { id: 4, name: 'New York', code: 'NY', trucks: 15, customers: 2341, revenue: 3542000, target: 3500000 },
  { id: 5, name: 'Michigan', code: 'MI', trucks: 11, customers: 1876, revenue: 2156000, target: 2500000 }
];

const DRIVERS = [
  { id: 1, name: 'Mike Sullivan', route: 'North County', truck: 'T-01', phone: '(724) 555-0142', status: 'delivering', gallonsRemaining: 1847, gallonsCommitted: 1420, gallonsLoaded: 2800, stopsComplete: 4, stopsTotal: 12, hoursOnDuty: 6.5, maxHours: 10, currentStop: 'Thompson Family', eta: 8, avgGPH: 48.2, incentiveEarned: 45, branch: 'PA' },
  { id: 2, name: 'Dave Martinez', route: 'South County', truck: 'T-02', phone: '(724) 555-0198', status: 'transit', gallonsRemaining: 2100, gallonsCommitted: 1650, gallonsLoaded: 2800, stopsComplete: 2, stopsTotal: 9, hoursOnDuty: 4.2, maxHours: 10, currentStop: 'Oakwood Restaurant', eta: 15, avgGPH: 52.1, incentiveEarned: 20, branch: 'PA' },
  { id: 3, name: 'Jim Patterson', route: 'Commercial', truck: 'T-03', phone: '(724) 555-0234', status: 'idle', gallonsRemaining: 890, gallonsCommitted: 600, gallonsLoaded: 2800, stopsComplete: 6, stopsTotal: 8, hoursOnDuty: 8.1, maxHours: 10, currentStop: null, eta: null, avgGPH: 41.8, incentiveEarned: 75, branch: 'PA' },
  { id: 4, name: 'Sarah Chen', route: 'East County', truck: 'T-04', phone: '(724) 555-0156', status: 'delivering', gallonsRemaining: 1650, gallonsCommitted: 1200, gallonsLoaded: 2800, stopsComplete: 3, stopsTotal: 11, hoursOnDuty: 5.8, maxHours: 10, currentStop: 'Heritage Church', eta: 12, avgGPH: 55.3, incentiveEarned: 30, branch: 'PA' },
  { id: 5, name: 'Tom Wilson', route: 'Cleveland Metro', truck: 'T-05', phone: '(216) 555-0187', status: 'delivering', gallonsRemaining: 1920, gallonsCommitted: 1500, gallonsLoaded: 2800, stopsComplete: 5, stopsTotal: 10, hoursOnDuty: 5.2, maxHours: 10, currentStop: 'Metro Hospital', eta: 10, avgGPH: 58.7, incentiveEarned: 55, branch: 'OH' },
  { id: 6, name: 'Bill Harris', route: 'Rural WV', truck: 'T-06', phone: '(304) 555-0234', status: 'transit', gallonsRemaining: 2450, gallonsCommitted: 800, gallonsLoaded: 2800, stopsComplete: 1, stopsTotal: 6, hoursOnDuty: 2.1, maxHours: 10, currentStop: null, eta: 22, avgGPH: 38.4, incentiveEarned: 0, branch: 'WV' }
];

const CUSTOMERS = [
  { id: 1, name: 'Johnson Farm', type: 'Agricultural', address: '2847 County Road 15, Greenville, PA', phone: '(724) 588-1234', tank: 1000, level: 8, monitored: true, lastDelivery: '2025-12-28', kFactor: 6.2, pricingTier: 'Volume Discount', pricePerGal: 2.45, tankOwnership: 'company', dnfFlag: false, fillDistance: 150, cluster: 'North Rural', willCallHistory: 0, paymentMethod: 'Invoice', balance: 0, taxExempt: true, taxType: 'Agricultural', branch: 'PA', servicePlan: 'Gold', appliances: ['Furnace', 'Water Heater', 'Grain Dryer'], preBuyGallons: 0, preBuyRemaining: 0 },
  { id: 2, name: 'Smith Residence', type: 'Residential', address: '142 Oak Street, Meadville, PA', phone: '(814) 333-5678', tank: 500, level: 34, monitored: false, lastDelivery: '2025-01-05', kFactor: 8.1, pricingTier: 'Auto-Delivery', pricePerGal: 2.58, tankOwnership: 'company', dnfFlag: false, fillDistance: 40, cluster: 'Meadville', willCallHistory: 0, paymentMethod: 'Auto-Pay', balance: 0, taxExempt: false, branch: 'PA', servicePlan: null, appliances: ['Furnace'], preBuyGallons: 500, preBuyRemaining: 312, preBuyPrice: 2.15 },
  { id: 3, name: 'Oakwood Restaurant', type: 'Commercial', address: '891 Industrial Park Dr, Sharon, PA', phone: '(724) 981-9999', tank: 250, level: 52, monitored: true, lastDelivery: '2025-01-15', kFactor: 4.3, pricingTier: 'Commercial Contract', pricePerGal: 2.42, tankOwnership: 'company', dnfFlag: false, fillDistance: 25, cluster: 'Sharon Commercial', isCommercialCritical: true, willCallHistory: 0, paymentMethod: 'Net-30', balance: 847.50, taxExempt: false, branch: 'PA', servicePlan: 'Silver', appliances: ['Commercial Range', 'Water Heater'], preBuyGallons: 0, preBuyRemaining: 0 },
  { id: 4, name: 'Thompson Family', type: 'Residential', address: '445 Church Lane, Grove City, PA', phone: '(724) 458-2345', tank: 330, level: 0, monitored: false, lastDelivery: '2025-01-02', kFactor: 7.5, pricingTier: 'Will-Call', pricePerGal: 2.85, tankOwnership: 'customer', dnfFlag: false, notes: '‚ö†Ô∏è AGGRESSIVE DOG IN BACKYARD', fillDistance: 30, cluster: 'Grove City', outOfGas: true, willCallHistory: 4, paymentMethod: 'COD', balance: 0, taxExempt: false, branch: 'PA', servicePlan: null, appliances: ['Furnace', 'Water Heater'], preBuyGallons: 0, preBuyRemaining: 0 },
  { id: 5, name: 'Heritage Church', type: 'Commercial', address: '1203 Maple Avenue, Franklin, PA', phone: '(814) 437-8765', tank: 500, level: 67, monitored: true, lastDelivery: '2025-01-10', kFactor: 5.8, pricingTier: 'Non-Profit Rate', pricePerGal: 2.52, tankOwnership: 'company', dnfFlag: false, fillDistance: 60, cluster: 'Franklin', willCallHistory: 0, paymentMethod: 'Invoice', balance: 0, taxExempt: true, taxType: 'Non-Profit', branch: 'PA', servicePlan: 'Gold', appliances: ['Commercial Furnace'], preBuyGallons: 0, preBuyRemaining: 0 },
  { id: 6, name: 'Miller Auto Shop', type: 'Commercial', address: '567 Main Street, Hermitage, PA', phone: '(724) 342-5555', tank: 250, level: 41, monitored: false, lastDelivery: '2025-01-08', kFactor: 6.9, pricingTier: 'Commercial Standard', pricePerGal: 2.55, tankOwnership: 'customer', dnfFlag: true, dnfReason: 'Past due balance $2,847', fillDistance: 35, cluster: 'Hermitage', willCallHistory: 3, paymentMethod: 'Invoice', balance: 2847.50, taxExempt: false, branch: 'PA', servicePlan: null, appliances: ['Space Heater'], preBuyGallons: 0, preBuyRemaining: 0 },
  { id: 7, name: 'Metro Hospital', type: 'Commercial', address: '1500 Health Way, Cleveland, OH', phone: '(216) 555-8000', tank: 2000, level: 45, monitored: true, lastDelivery: '2025-01-14', kFactor: 3.2, pricingTier: 'Enterprise', pricePerGal: 2.28, tankOwnership: 'company', dnfFlag: false, fillDistance: 50, cluster: 'Cleveland Metro', isCommercialCritical: true, willCallHistory: 0, paymentMethod: 'Net-30', balance: 4250.00, taxExempt: true, taxType: 'Medical', branch: 'OH', servicePlan: 'Gold', appliances: ['Commercial Boiler', 'Generator'], preBuyGallons: 5000, preBuyRemaining: 3200, preBuyPrice: 2.05 },
  { id: 8, name: 'Hendricks Poultry', type: 'Agricultural', address: '4521 Route 50, Charleston, WV', phone: '(304) 555-2847', tank: 1500, level: 22, monitored: true, lastDelivery: '2025-01-12', kFactor: 2.8, pricingTier: 'Ag Volume', pricePerGal: 2.35, tankOwnership: 'customer', dnfFlag: false, fillDistance: 200, cluster: 'Rural WV', isCommercialCritical: true, willCallHistory: 0, paymentMethod: 'Split', splitLandlord: 40, splitTenant: 60, balance: 0, taxExempt: true, taxType: 'Agricultural', branch: 'WV', servicePlan: null, appliances: ['Poultry House Heaters x4'], harvestMode: true, preBuyGallons: 0, preBuyRemaining: 0 }
];

const UNASSIGNED = [
  { id: 101, customer: 'Peterson Farm', address: '3201 Route 19, Meadville', type: 'Will-Call', estGallons: 450, priority: 'normal', cluster: 'Meadville', paymentMethod: 'Invoice', branch: 'PA' },
  { id: 102, customer: 'Greenfield Diner', address: '112 Main St, Sharon', type: 'Emergency', estGallons: 180, priority: 'urgent', cluster: 'Sharon Commercial', isCommercialCritical: true, paymentMethod: 'COD', branch: 'PA' },
  { id: 103, customer: 'Adams Residence', address: '567 Elm Drive, Franklin', type: 'Will-Call', estGallons: 220, priority: 'normal', cluster: 'Franklin', paymentMethod: 'Auto-Pay', branch: 'PA' },
  { id: 104, customer: 'Valley Farms', address: '8900 County Rd 12, Akron', type: 'Scheduled', estGallons: 800, priority: 'normal', cluster: 'Akron Rural', paymentMethod: 'Net-30', branch: 'OH' }
];

const ARCHIVE = [
  { id: 1, date: '2024-12-15', customer: 'Smith Residence', gallons: 287, price: 2.45, total: 703.15 },
  { id: 2, date: '2024-11-28', customer: 'Smith Residence', gallons: 312, price: 2.52, total: 786.24 },
  { id: 3, date: '2024-10-14', customer: 'Smith Residence', gallons: 245, price: 2.38, total: 583.10 },
  { id: 4, date: '2024-09-02', customer: 'Smith Residence', gallons: 198, price: 2.29, total: 453.42 },
  { id: 5, date: '2024-07-20', customer: 'Smith Residence', gallons: 156, price: 2.15, total: 335.40 },
  { id: 6, date: '2023-12-24', customer: 'Smith Residence', gallons: 298, price: 2.89, total: 861.22 },
  { id: 7, date: '2023-11-15', customer: 'Smith Residence', gallons: 267, price: 2.78, total: 742.26 },
  { id: 8, date: '2022-12-22', customer: 'Smith Residence', gallons: 312, price: 3.15, total: 982.80 },
  { id: 9, date: '2021-12-24', customer: 'Smith Residence', gallons: 289, price: 2.45, total: 708.05 },
  { id: 10, date: '2020-01-08', customer: 'Smith Residence', gallons: 276, price: 1.89, total: 521.64 }
];

const ACTIVITY = [
  { id: 1, type: 'payment', message: 'Payment received - Thompson Family', detail: '$902.40 via card', time: '1 min ago', icon: 'üí≥' },
  { id: 2, type: 'delivery', message: 'Mike completed Thompson Family', detail: '264 gal + Leak Check', time: '2 min ago', icon: '‚úì' },
  { id: 3, type: 'notification', message: 'SMS sent to Thompson Family', detail: '"Your delivery is complete"', time: '2 min ago', icon: 'üì±' },
  { id: 4, type: 'alert', message: 'Tank critical: Johnson Farm', detail: '8% remaining', time: '5 min ago', icon: '‚ö†' },
  { id: 5, type: 'injection', message: 'RUSH stop added to Mike', detail: 'Greenfield Diner - REROUTING', time: '8 min ago', icon: 'üö®' },
  { id: 6, type: 'incentive', message: 'Mike earned $25 bonus', detail: 'Flagged rusty tank lead', time: '12 min ago', icon: 'üíµ' }
];

const SURCHARGES = [
  { id: 'leak', name: 'Leak Check', amount: 75, icon: 'üîç' },
  { id: 'oog', name: 'Out-of-Gas', amount: 75, icon: '‚õΩ' },
  { id: 'saturday', name: 'Saturday', amount: 35, icon: 'üìÖ' },
  { id: 'after', name: 'After Hours', amount: 50, icon: 'üåô' },
  { id: 'standby', name: 'Standby', amount: 25, icon: '‚è±Ô∏è' },
  { id: 'long', name: 'Long Pull', amount: 25, icon: 'üîó' },
  { id: 'difficult', name: 'Difficult Access', amount: 35, icon: 'üöß' },
  { id: 'rush', name: 'Same Day Rush', amount: 45, icon: '‚ö°' },
  { id: 'prime', name: 'Prime & Start', amount: 50, icon: 'üî•' }
];

const PRICING_TIERS = {
  starter: { name: 'Starter', setup: 4995, perTruck: 99, features: ['Customer database', 'Delivery tickets', 'Driver app', 'Leak check interlock', 'Surcharge capture', 'Route clustering', 'QuickBooks sync', 'Basic reports'] },
  growth: { name: 'Growth', setup: 14995, perTruck: 149, features: ['Everything in Starter', 'Customer portal', 'COD payments (Stripe)', 'Upsell prompts', 'Review requests', 'SMS notifications', 'Driver leaderboard'] },
  enterprise: { name: 'Enterprise', setup: 29995, perTruck: 199, features: ['Everything in Growth', 'Multi-location dashboard', 'Role-based permissions', 'Tank monitors', 'Degree-day scheduling', 'Dedicated support', 'SLA guarantee', 'Source code escrow'] }
};

const ADDONS = {
  api: { name: 'API/Integrations', price: 49, desc: 'HubSpot, ServiceTitan, Zapier, custom API' },
  compliance: { name: 'Compliance Pack', price: 29, desc: 'Extended audit logs, 24/7 SLA, data retention' },
  ag: { name: 'Ag Operations', price: 39, desc: 'Tax exemptions per tank, split billing, harvest mode' },
  prebuy: { name: 'Pre-Buy/Contracts', price: 29, desc: 'Gallon drawdown, contract tracking, pre-paid balance' }
};

// Utilities
const getStatusColor = (s) => s === 'delivering' ? 'bg-emerald-500' : s === 'transit' ? 'bg-sky-500' : s === 'idle' ? 'bg-amber-500' : 'bg-red-500';
const getTankColor = (l) => l < 10 ? 'bg-red-500 text-white' : l < 20 ? 'bg-orange-500 text-white' : l < 40 ? 'bg-amber-500 text-slate-900' : 'bg-emerald-500 text-white';
const getOvertimeColor = (h, max) => h >= max ? 'text-red-400' : h >= max - 1.5 ? 'text-amber-400' : 'text-emerald-400';
const calcEFT = (stops, complete, hoursLeft) => {
  const remaining = stops - complete;
  const avgTimePerStop = 0.4; // 24 min avg
  return (remaining * avgTimePerStop).toFixed(1);
};

// ============================================
// MAIN APP
// ============================================
export default function PropaneV4() {
  const [view, setView] = useState('dispatch');
  const [role, setRole] = useState('super'); // super, branch, dispatcher, driver
  const [branch, setBranch] = useState('all');
  const [dark, setDark] = useState(true);
  const [compactView, setCompactView] = useState(false);
  const [selectedDriver, setSelectedDriver] = useState(null);
  const [selectedCustomer, setSelectedCustomer] = useState(null);
  const [showPricing, setShowPricing] = useState(false);
  const [showArchive, setShowArchive] = useState(false);
  const [showFreshStart, setShowFreshStart] = useState(false);
  const [showPortal, setShowPortal] = useState(false);
  const [showLeaderboard, setShowLeaderboard] = useState(true);
  const [meterMode, setMeterMode] = useState('manual'); // manual, ocr, bluetooth
  const [rushInjection, setRushInjection] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');

  // Pricing configurator state
  const [selectedTier, setSelectedTier] = useState('growth');
  const [truckCount, setTruckCount] = useState(8);
  const [selectedAddons, setSelectedAddons] = useState(['api']);

  const t = {
    bg: dark ? 'bg-slate-950' : 'bg-slate-100',
    bg2: dark ? 'bg-slate-900' : 'bg-white',
    bg3: dark ? 'bg-slate-800' : 'bg-slate-200',
    text: dark ? 'text-slate-100' : 'text-slate-900',
    muted: dark ? 'text-slate-500' : 'text-slate-500',
    border: dark ? 'border-slate-800' : 'border-slate-300'
  };

  // Keyboard shortcuts for dispatcher
  useEffect(() => {
    const handleKey = (e) => {
      if (e.metaKey || e.ctrlKey) {
        if (e.key === 'f') { e.preventDefault(); document.getElementById('search-input')?.focus(); }
        if (e.key === '1') { e.preventDefault(); setView('dispatch'); }
        if (e.key === '2') { e.preventDefault(); setView('driver'); }
        if (e.key === '3') { e.preventDefault(); setView('customers'); }
      }
      if (e.key === 'Escape') { setSelectedDriver(null); setSelectedCustomer(null); }
    };
    window.addEventListener('keydown', handleKey);
    return () => window.removeEventListener('keydown', handleKey);
  }, []);

  // Filter data by branch
  const filteredDrivers = branch === 'all' ? DRIVERS : DRIVERS.filter(d => d.branch === branch);
  const filteredCustomers = branch === 'all' ? CUSTOMERS : CUSTOMERS.filter(c => c.branch === branch);
  const filteredUnassigned = branch === 'all' ? UNASSIGNED : UNASSIGNED.filter(u => u.branch === branch);

  // Calculate pricing
  const calcPrice = () => {
    const tier = PRICING_TIERS[selectedTier];
    const addonTotal = selectedAddons.reduce((sum, a) => sum + ADDONS[a].price, 0);
    const monthly = (tier.perTruck + addonTotal) * truckCount;
    const year1 = tier.setup + (monthly * 12);
    const year2 = monthly * 12;
    return { setup: tier.setup, monthly, year1, year2 };
  };

  return (
    <div className={`min-h-screen ${t.bg} ${t.text} font-sans`}>
      {/* Rush Injection Alert */}
      {rushInjection && (
        <div className="fixed top-0 left-0 right-0 z-50 bg-red-600 text-white px-6 py-4 flex items-center justify-between animate-pulse">
          <div className="flex items-center gap-4">
            <span className="text-3xl">üö®</span>
            <div>
              <p className="font-bold text-lg">RUSH STOP INJECTED - DRIVER NOTIFIED</p>
              <p className="opacity-90">Greenfield Diner added to Mike's route - Rerouting in progress</p>
            </div>
          </div>
          <button onClick={() => setRushInjection(false)} className="bg-white text-red-600 font-bold px-4 py-2 rounded-lg">Dismiss</button>
        </div>
      )}

      {/* Header */}
      <header className={`${t.bg2} border-b ${t.border} px-6 py-4 ${rushInjection ? 'mt-16' : ''}`}>
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div className="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center font-black text-slate-900">
              {role === 'super' ? 'AE' : 'VP'}
            </div>
            <div>
              <h1 className="text-lg font-bold">{role === 'super' ? 'Apex Energy Holdings' : 'Valley Propane & Heating'}</h1>
              <p className={`text-xs ${t.muted}`}>{new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
            </div>
            
            {/* Branch Selector (Aggregator) */}
            {role === 'super' && (
              <select value={branch} onChange={(e) => setBranch(e.target.value)} 
                className={`ml-4 ${t.bg3} ${t.text} rounded-lg px-3 py-2 border ${t.border} text-sm`}>
                <option value="all">All Branches (50 trucks)</option>
                {BRANCHES.map(b => <option key={b.id} value={b.code}>{b.name} ({b.trucks} trucks)</option>)}
              </select>
            )}
          </div>
          
          <div className="flex items-center gap-3">
            {/* Search with hotkey hint */}
            <div className="relative">
              <input id="search-input" type="text" placeholder="Search... (‚åòF)" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)}
                className={`${t.bg3} rounded-lg px-4 py-2 pl-10 w-64 border ${t.border} text-sm`} />
              <span className="absolute left-3 top-2.5">üîç</span>
            </div>

            <button onClick={() => setShowPricing(true)} className="flex items-center gap-2 bg-emerald-500/20 text-emerald-400 rounded-xl px-4 py-2 border border-emerald-500/30">
              <span>üí∞</span><span className="text-sm font-bold">Pricing</span>
            </button>
            
            <button onClick={() => setCompactView(!compactView)} className={`${t.bg3} rounded-xl px-3 py-2 border ${t.border}`} title="Toggle Compact View">
              {compactView ? '‚ñ§' : '‚ñ¶'}
            </button>
            
            <button onClick={() => setDark(!dark)} className={`${t.bg3} rounded-xl px-3 py-2 border ${t.border}`}>
              {dark ? '‚òÄÔ∏è' : 'üåô'}
            </button>

            {/* Role Switcher */}
            <select value={role} onChange={(e) => setRole(e.target.value)} 
              className={`${t.bg3} ${t.text} rounded-lg px-3 py-2 border ${t.border} text-sm`}>
              <option value="super">Super Admin (CFO)</option>
              <option value="branch">Branch Manager</option>
              <option value="dispatcher">Dispatcher</option>
              <option value="driver">Driver</option>
            </select>
          </div>
        </div>
        
        {/* Navigation */}
        <nav className="flex gap-2 mt-4">
          {[
            { id: 'dispatch', label: 'Dispatch', icon: 'üó∫Ô∏è', roles: ['super', 'branch', 'dispatcher'] },
            { id: 'driver', label: 'Driver App', icon: 'üì±', roles: ['super', 'branch', 'dispatcher', 'driver'] },
            { id: 'customers', label: 'Customers', icon: 'üë•', roles: ['super', 'branch', 'dispatcher'] },
            { id: 'tanks', label: 'Tanks', icon: '‚õΩ', roles: ['super', 'branch', 'dispatcher'] },
            { id: 'invoicing', label: 'Invoicing', icon: 'üí∞', roles: ['super', 'branch'] },
            { id: 'reports', label: 'Reports', icon: 'üìä', roles: ['super', 'branch'] },
            { id: 'hq', label: 'HQ Dashboard', icon: 'üè¢', roles: ['super'] }
          ].filter(tab => tab.roles.includes(role)).map(tab => (
            <button key={tab.id} onClick={() => setView(tab.id)}
              className={`flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all ${view === tab.id ? 'bg-orange-500 text-slate-900' : `${t.bg3} hover:bg-slate-700`}`}>
              <span>{tab.icon}</span>{tab.label}
            </button>
          ))}
        </nav>
        
        {/* Keyboard shortcuts hint for dispatcher */}
        {role === 'dispatcher' && (
          <div className={`mt-2 text-xs ${t.muted}`}>
            Shortcuts: ‚åòF Search | ‚åò1 Dispatch | ‚åò2 Driver | ‚åò3 Customers | Esc Close
          </div>
        )}
      </header>

      {/* Main Content */}
      <main className="p-6">
        {view === 'dispatch' && <DispatchView t={t} drivers={filteredDrivers} unassigned={filteredUnassigned} compactView={compactView} 
          onSelectDriver={setSelectedDriver} selectedDriver={selectedDriver} onRushInject={() => setRushInjection(true)} showLeaderboard={showLeaderboard && role !== 'branch'} />}
        {view === 'driver' && <DriverView t={t} meterMode={meterMode} setMeterMode={setMeterMode} />}
        {view === 'customers' && <CustomerView t={t} customers={filteredCustomers} onShowArchive={() => setShowArchive(true)} compactView={compactView} searchQuery={searchQuery} />}
        {view === 'tanks' && <TankView t={t} customers={filteredCustomers} />}
        {view === 'invoicing' && <InvoicingView t={t} />}
        {view === 'reports' && <ReportsView t={t} showLeaderboard={showLeaderboard} setShowLeaderboard={setShowLeaderboard} />}
        {view === 'hq' && <HQDashboard t={t} branches={BRANCHES} />}
      </main>

      {/* Modals */}
      {showPricing && <PricingModal t={t} onClose={() => setShowPricing(false)} 
        tier={selectedTier} setTier={setSelectedTier} trucks={truckCount} setTrucks={setTruckCount}
        addons={selectedAddons} setAddons={setSelectedAddons} calcPrice={calcPrice} />}
      {showArchive && <ArchiveModal t={t} onClose={() => setShowArchive(false)} />}
      {showFreshStart && <FreshStartModal t={t} onClose={() => setShowFreshStart(false)} />}
      {showPortal && <PortalModal t={t} onClose={() => setShowPortal(false)} />}
    </div>
  );
}

// ============================================
// DISPATCH VIEW - Dispatcher Power Features
// ============================================
function DispatchView({ t, drivers, unassigned, compactView, onSelectDriver, selectedDriver, onRushInject, showLeaderboard }) {
  return (
    <div className="flex gap-6">
      {/* Left: Unassigned Orders */}
      <div className={`w-72 ${t.bg2} rounded-2xl p-4 border ${t.border}`}>
        <div className="flex items-center justify-between mb-4">
          <h2 className="font-bold">Unassigned</h2>
          <span className={`${t.bg3} px-2 py-1 rounded-lg text-xs font-bold`}>{unassigned.length}</span>
        </div>
        <div className="space-y-2">
          {unassigned.map(order => (
            <div key={order.id} className={`${t.bg3} p-3 rounded-xl cursor-grab ${order.priority === 'urgent' ? 'border-2 border-red-500' : ''}`}>
              <div className="flex items-center justify-between">
                <span className="font-semibold text-sm">{order.customer}</span>
                {order.priority === 'urgent' && <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">RUSH</span>}
              </div>
              <p className={`text-xs ${t.muted} mt-1`}>{order.address}</p>
              <div className="flex items-center justify-between mt-2">
                <span className={`text-xs ${t.muted}`}>~{order.estGallons} gal</span>
                <button onClick={onRushInject} className="text-xs bg-orange-500 text-slate-900 px-2 py-1 rounded font-bold">+ Route</button>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Center: Driver Routes */}
      <div className="flex-1">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold">Active Routes</h2>
          <div className="flex items-center gap-2">
            <span className={`text-sm ${t.muted}`}>Physical / Available</span>
          </div>
        </div>

        {compactView ? (
          // COMPACT VIEW - Dispatcher requested spreadsheet mode
          <div className={`${t.bg2} rounded-xl overflow-hidden border ${t.border}`}>
            <table className="w-full text-sm">
              <thead className={t.bg3}>
                <tr>
                  <th className="text-left p-3">Driver</th>
                  <th className="text-left p-3">Route</th>
                  <th className="text-center p-3">Status</th>
                  <th className="text-right p-3">Physical</th>
                  <th className="text-right p-3">Available</th>
                  <th className="text-right p-3">Stops</th>
                  <th className="text-right p-3">Hours</th>
                  <th className="text-right p-3">EFT</th>
                </tr>
              </thead>
              <tbody>
                {drivers.map(d => {
                  const available = d.gallonsRemaining - d.gallonsCommitted;
                  const eft = calcEFT(d.stopsTotal, d.stopsComplete, d.maxHours - d.hoursOnDuty);
                  const overtimeRisk = parseFloat(eft) + d.hoursOnDuty > d.maxHours;
                  return (
                    <tr key={d.id} className={`border-t ${t.border} hover:${t.bg3} cursor-pointer ${overtimeRisk ? 'bg-red-500/10' : ''}`} onClick={() => onSelectDriver(d)}>
                      <td className="p-3 font-semibold">{d.name}</td>
                      <td className="p-3">{d.route}</td>
                      <td className="p-3 text-center"><span className={`${getStatusColor(d.status)} px-2 py-1 rounded-full text-xs text-white`}>{d.status}</span></td>
                      <td className="p-3 text-right font-mono">{d.gallonsRemaining.toLocaleString()}</td>
                      <td className={`p-3 text-right font-mono font-bold ${available < 300 ? 'text-red-400' : 'text-emerald-400'}`}>{available.toLocaleString()}</td>
                      <td className="p-3 text-right">{d.stopsComplete}/{d.stopsTotal}</td>
                      <td className={`p-3 text-right font-mono ${getOvertimeColor(d.hoursOnDuty, d.maxHours)}`}>{d.hoursOnDuty}h</td>
                      <td className={`p-3 text-right font-mono ${overtimeRisk ? 'text-red-400 font-bold' : ''}`}>{eft}h</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        ) : (
          // CARD VIEW
          <div className="grid grid-cols-2 gap-4">
            {drivers.map(d => {
              const available = d.gallonsRemaining - d.gallonsCommitted;
              const eft = calcEFT(d.stopsTotal, d.stopsComplete, d.maxHours - d.hoursOnDuty);
              const overtimeRisk = parseFloat(eft) + d.hoursOnDuty > d.maxHours;
              return (
                <div key={d.id} onClick={() => onSelectDriver(d)} className={`${t.bg2} p-4 rounded-2xl border ${t.border} cursor-pointer hover:border-orange-500/50 transition-all ${overtimeRisk ? 'border-red-500/50' : ''}`}>
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-3">
                      <div className={`w-3 h-3 rounded-full ${getStatusColor(d.status)}`} />
                      <div>
                        <p className="font-bold">{d.name}</p>
                        <p className={`text-xs ${t.muted}`}>{d.truck} ‚Ä¢ {d.route}</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className={`text-sm font-mono ${getOvertimeColor(d.hoursOnDuty, d.maxHours)}`}>{d.hoursOnDuty}h / {d.maxHours}h</p>
                      {overtimeRisk && <p className="text-xs text-red-400 font-bold">‚ö†Ô∏è OT RISK</p>}
                    </div>
                  </div>
                  
                  {/* Inventory - Physical vs Available */}
                  <div className={`${t.bg3} p-3 rounded-xl mb-3`}>
                    <div className="flex justify-between text-xs mb-1">
                      <span className={t.muted}>Physical Inventory</span>
                      <span className="font-mono">{d.gallonsRemaining.toLocaleString()} gal</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className="font-semibold">Available to Sell</span>
                      <span className={`font-mono font-bold ${available < 300 ? 'text-red-400' : 'text-emerald-400'}`}>{available.toLocaleString()} gal</span>
                    </div>
                    <div className="w-full bg-slate-700 rounded-full h-2 mt-2">
                      <div className="bg-emerald-500 h-2 rounded-full" style={{ width: `${(available / d.gallonsLoaded) * 100}%` }} />
                    </div>
                  </div>

                  <div className="flex justify-between text-sm">
                    <span>Stops: {d.stopsComplete}/{d.stopsTotal}</span>
                    <span>EFT: +{eft}h</span>
                    {d.incentiveEarned > 0 && <span className="text-emerald-400">üíµ ${d.incentiveEarned}</span>}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* Right: Activity Feed */}
      <div className={`w-80 ${t.bg2} rounded-2xl p-4 border ${t.border}`}>
        <h2 className="font-bold mb-4">Activity Feed</h2>
        <div className="space-y-3">
          {ACTIVITY.map(a => (
            <div key={a.id} className={`${t.bg3} p-3 rounded-xl ${a.type === 'injection' ? 'border border-red-500/50' : ''}`}>
              <div className="flex items-center gap-2">
                <span className="text-lg">{a.icon}</span>
                <div className="flex-1">
                  <p className="text-sm font-semibold">{a.message}</p>
                  <p className={`text-xs ${t.muted}`}>{a.detail}</p>
                </div>
                <span className={`text-xs ${t.muted}`}>{a.time}</span>
              </div>
            </div>
          ))}
        </div>

        {/* Driver Leaderboard (toggleable) */}
        {showLeaderboard && (
          <div className="mt-6">
            <h3 className="font-bold mb-3">Driver Leaderboard</h3>
            <div className="space-y-2">
              {[...DRIVERS].sort((a, b) => b.avgGPH - a.avgGPH).slice(0, 4).map((d, i) => (
                <div key={d.id} className={`flex items-center justify-between ${t.bg3} p-2 rounded-lg`}>
                  <div className="flex items-center gap-2">
                    <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${i === 0 ? 'bg-amber-500 text-slate-900' : t.bg}`}>{i + 1}</span>
                    <span className="text-sm">{d.name}</span>
                  </div>
                  <span className="text-sm font-mono text-emerald-400">{d.avgGPH} GPH</span>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ============================================
// DRIVER VIEW - Mac's Feedback
// ============================================
function DriverView({ t, meterMode, setMeterMode }) {
  const [currentStop] = useState(CUSTOMERS[3]); // Thompson - Out of gas
  const [meterStart, setMeterStart] = useState('');
  const [meterEnd, setMeterEnd] = useState('');
  const [showLeakCheck, setShowLeakCheck] = useState(false);
  const [leakPassed, setLeakPassed] = useState(false);
  const [showPayment, setShowPayment] = useState(false);
  const [selectedSurcharges, setSelectedSurcharges] = useState(['oog']);
  const [showIncentive, setShowIncentive] = useState(false);

  const gallonsDelivered = meterStart && meterEnd ? Math.abs(parseInt(meterEnd) - parseInt(meterStart)) : 0;
  const total = gallonsDelivered * currentStop.pricePerGal + selectedSurcharges.reduce((sum, id) => {
    const s = SURCHARGES.find(x => x.id === id);
    return sum + (s ? s.amount : 0);
  }, 0);

  return (
    <div className="max-w-md mx-auto">
      {/* Offline indicator */}
      <div className={`${t.bg2} rounded-xl p-3 mb-4 flex items-center justify-between border ${t.border}`}>
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 bg-emerald-500 rounded-full animate-pulse" />
          <span className="text-sm">Online - Synced</span>
        </div>
        <span className={`text-xs ${t.muted}`}>Last sync: 2 min ago</span>
      </div>

      {/* Current Stop Card */}
      <div className={`${t.bg2} rounded-2xl p-5 border ${t.border} mb-4`}>
        {/* Safety Notes - RED BOX */}
        {currentStop.notes && (
          <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-3 mb-4">
            <p className="text-red-400 font-bold text-sm">{currentStop.notes}</p>
          </div>
        )}

        {/* Out of Gas Interlock */}
        {currentStop.outOfGas && !leakPassed && (
          <div className="bg-amber-500/20 border border-amber-500/50 rounded-xl p-3 mb-4">
            <p className="text-amber-400 font-bold">‚ö†Ô∏è OUT OF GAS - LEAK CHECK REQUIRED</p>
            <p className={`text-sm ${t.muted} mt-1`}>NFPA 54 compliance. Cannot complete without test.</p>
          </div>
        )}

        <div className="flex items-center justify-between mb-4">
          <div>
            <h2 className="text-xl font-bold">{currentStop.name}</h2>
            <p className={t.muted}>{currentStop.address}</p>
          </div>
          <div className="text-right">
            <p className="text-lg font-bold text-orange-500">${currentStop.pricePerGal}/gal</p>
            <p className={`text-xs ${t.muted}`}>{currentStop.pricingTier}</p>
          </div>
        </div>

        {/* Service Plan Badge */}
        {currentStop.servicePlan && (
          <div className={`inline-block px-3 py-1 rounded-full text-sm font-bold mb-4 ${currentStop.servicePlan === 'Gold' ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-500/20 text-slate-400'}`}>
            {currentStop.servicePlan} Plan
          </div>
        )}

        {/* Tank Info */}
        <div className={`${t.bg3} p-4 rounded-xl mb-4`}>
          <div className="flex justify-between mb-2">
            <span>Tank: {currentStop.tank} gal ({currentStop.tankOwnership === 'company' ? 'COT' : 'Customer'})</span>
            <span className={getTankColor(currentStop.level) + ' px-2 py-0.5 rounded'}>{currentStop.level}%</span>
          </div>
          {currentStop.fillDistance > 75 && (
            <div className="text-amber-400 text-sm mt-2">‚ö†Ô∏è Long Pull: {currentStop.fillDistance} ft</div>
          )}
        </div>

        {/* Meter Entry - Mac's concern */}
        <div className="mb-4">
          <div className="flex items-center justify-between mb-2">
            <label className="font-semibold">Meter Entry</label>
            <div className="flex gap-1">
              {['manual', 'ocr', 'bluetooth'].map(mode => (
                <button key={mode} onClick={() => setMeterMode(mode)}
                  className={`px-3 py-1 rounded-lg text-xs font-bold ${meterMode === mode ? 'bg-orange-500 text-slate-900' : t.bg3}`}>
                  {mode === 'manual' ? '‚å®Ô∏è' : mode === 'ocr' ? 'üì∑' : 'üì∂'}
                </button>
              ))}
            </div>
          </div>

          {meterMode === 'ocr' && (
            <div className={`${t.bg3} p-4 rounded-xl text-center mb-3`}>
              <button className="bg-sky-500 text-white px-6 py-4 rounded-xl font-bold text-lg w-full">
                üì∑ SCAN METER
              </button>
              <p className={`text-xs ${t.muted} mt-2`}>Point camera at LCR-II display</p>
            </div>
          )}

          {meterMode === 'bluetooth' && (
            <div className={`${t.bg3} p-4 rounded-xl mb-3`}>
              <div className="flex items-center justify-between">
                <span>LCR-II Connected</span>
                <span className="text-emerald-400">‚óè</span>
              </div>
              <p className={`text-xs ${t.muted} mt-1`}>Readings auto-populate on pump</p>
            </div>
          )}

          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className={`text-xs ${t.muted}`}>Start</label>
              <input type="number" value={meterStart} onChange={(e) => setMeterStart(e.target.value)} placeholder="0000"
                className={`w-full ${t.bg3} rounded-xl p-4 text-2xl font-mono text-center border ${t.border}`} />
            </div>
            <div>
              <label className={`text-xs ${t.muted}`}>End</label>
              <input type="number" value={meterEnd} onChange={(e) => setMeterEnd(e.target.value)} placeholder="0000"
                className={`w-full ${t.bg3} rounded-xl p-4 text-2xl font-mono text-center border ${t.border}`} />
            </div>
          </div>
          {gallonsDelivered > 0 && (
            <div className="text-center mt-2 text-2xl font-bold text-emerald-400">{gallonsDelivered} gallons</div>
          )}
        </div>

        {/* Quick Surcharges */}
        <div className="mb-4">
          <label className="font-semibold block mb-2">Surcharges</label>
          <div className="grid grid-cols-4 gap-2">
            {SURCHARGES.map(s => (
              <button key={s.id} onClick={() => {
                setSelectedSurcharges(prev => prev.includes(s.id) ? prev.filter(x => x !== s.id) : [...prev, s.id]);
              }} className={`p-3 rounded-xl text-center ${selectedSurcharges.includes(s.id) ? 'bg-orange-500 text-slate-900' : t.bg3}`}>
                <div className="text-xl">{s.icon}</div>
                <div className="text-xs font-bold mt-1">${s.amount}</div>
              </button>
            ))}
          </div>
        </div>

        {/* Upsell with Incentive - Mac's feedback */}
        <div className={`${t.bg3} p-4 rounded-xl mb-4`}>
          <div className="flex items-center justify-between">
            <div>
              <p className="font-semibold">Tank Condition?</p>
              <p className={`text-xs ${t.muted}`}>Flag issues for service lead</p>
            </div>
            <div className="flex gap-2">
              <button onClick={() => setShowIncentive(true)} className="bg-amber-500/20 text-amber-400 px-4 py-2 rounded-xl font-bold">
                üõ†Ô∏è Rusty (+$25)
              </button>
              <button className={`${t.bg} px-4 py-2 rounded-xl`}>‚úì Good</button>
            </div>
          </div>
        </div>

        {/* New Appliance Button - Hybrid Owner feedback */}
        <button className={`w-full ${t.bg3} p-4 rounded-xl mb-4 text-left`}>
          <span className="font-semibold">üîç New Appliance Spotted?</span>
          <p className={`text-xs ${t.muted}`}>Resets K-Factor calculation</p>
        </button>

        {/* Total */}
        <div className={`${t.bg3} p-4 rounded-xl mb-4`}>
          <div className="flex justify-between text-lg font-bold">
            <span>Total Due</span>
            <span className="text-emerald-400">${total.toFixed(2)}</span>
          </div>
          <p className={`text-xs ${t.muted}`}>{currentStop.paymentMethod}</p>
        </div>

        {/* Action Buttons */}
        <div className="space-y-3">
          {currentStop.outOfGas && !leakPassed && (
            <button onClick={() => setShowLeakCheck(true)} className="w-full bg-amber-500 text-slate-900 p-5 rounded-2xl font-bold text-xl">
              üîç PERFORM LEAK CHECK
            </button>
          )}

          {currentStop.paymentMethod === 'COD' && (
            <button onClick={() => setShowPayment(true)} disabled={currentStop.outOfGas && !leakPassed}
              className={`w-full p-5 rounded-2xl font-bold text-xl ${currentStop.outOfGas && !leakPassed ? 'bg-slate-600 text-slate-400' : 'bg-sky-500 text-white'}`}>
              üí≥ COLLECT PAYMENT
            </button>
          )}

          <button disabled={currentStop.outOfGas && !leakPassed}
            className={`w-full p-5 rounded-2xl font-bold text-xl ${currentStop.outOfGas && !leakPassed ? 'bg-slate-600 text-slate-400' : 'bg-emerald-500 text-white'}`}>
            ‚úì COMPLETE DELIVERY
          </button>
        </div>
      </div>

      {/* Leak Check Modal */}
      {showLeakCheck && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
          <div className={`${t.bg2} rounded-2xl p-6 max-w-sm w-full`}>
            <h3 className="text-xl font-bold mb-4">‚õΩ Out-of-Gas Leak Check</h3>
            <p className={`${t.muted} mb-4`}>NFPA 54 requires pressure test before delivery.</p>
            <div className="space-y-4 mb-6">
              <div>
                <label className={`text-sm ${t.muted}`}>Test Pressure (PSI)</label>
                <input type="number" placeholder="11" className={`w-full ${t.bg3} rounded-xl p-3 mt-1`} />
              </div>
              <div>
                <label className={`text-sm ${t.muted}`}>Hold Time (minutes)</label>
                <input type="number" placeholder="3" className={`w-full ${t.bg3} rounded-xl p-3 mt-1`} />
              </div>
            </div>
            <div className="flex gap-3">
              <button onClick={() => { setLeakPassed(true); setShowLeakCheck(false); }} className="flex-1 bg-emerald-500 text-white p-4 rounded-xl font-bold">‚úì PASS</button>
              <button className="flex-1 bg-red-500 text-white p-4 rounded-xl font-bold">‚úó FAIL</button>
            </div>
            <button onClick={() => setShowLeakCheck(false)} className={`w-full mt-3 ${t.bg3} p-3 rounded-xl`}>Cancel</button>
          </div>
        </div>
      )}

      {/* Incentive Popup */}
      {showIncentive && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
          <div className={`${t.bg2} rounded-2xl p-6 max-w-sm w-full text-center`}>
            <div className="text-6xl mb-4">üíµ</div>
            <h3 className="text-2xl font-bold text-emerald-400 mb-2">+$25 Earned!</h3>
            <p className={t.muted}>Tank condition flagged. Sales lead created.</p>
            <button onClick={() => setShowIncentive(false)} className="mt-6 bg-emerald-500 text-white px-8 py-3 rounded-xl font-bold">Nice!</button>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================
// CUSTOMER VIEW - With Archive
// ============================================
function CustomerView({ t, customers, onShowArchive, compactView, searchQuery }) {
  const filtered = searchQuery ? customers.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase())) : customers;
  
  return (
    <div>
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-bold">Customers ({filtered.length})</h2>
        <button onClick={onShowArchive} className={`${t.bg3} px-4 py-2 rounded-xl text-sm font-bold`}>üìú View Archive</button>
      </div>

      {compactView ? (
        <div className={`${t.bg2} rounded-xl overflow-hidden border ${t.border}`}>
          <table className="w-full text-sm">
            <thead className={t.bg3}>
              <tr>
                <th className="text-left p-3">Name</th>
                <th className="text-left p-3">Type</th>
                <th className="text-center p-3">Tank</th>
                <th className="text-center p-3">Level</th>
                <th className="text-right p-3">Price</th>
                <th className="text-center p-3">Tax</th>
                <th className="text-center p-3">Pre-Buy</th>
                <th className="text-center p-3">Status</th>
              </tr>
            </thead>
            <tbody>
              {filtered.map(c => (
                <tr key={c.id} className={`border-t ${t.border} hover:${t.bg3} cursor-pointer ${c.dnfFlag ? 'bg-red-500/10' : ''}`}>
                  <td className="p-3 font-semibold">{c.name}</td>
                  <td className="p-3">{c.type}</td>
                  <td className="p-3 text-center">{c.tank}g</td>
                  <td className="p-3 text-center"><span className={`${getTankColor(c.level)} px-2 py-0.5 rounded text-xs`}>{c.level}%</span></td>
                  <td className="p-3 text-right font-mono">${c.pricePerGal}</td>
                  <td className="p-3 text-center">{c.taxExempt ? <span className="text-emerald-400">‚úì {c.taxType}</span> : '‚Äî'}</td>
                  <td className="p-3 text-center">{c.preBuyRemaining > 0 ? <span className="text-sky-400">{c.preBuyRemaining}g</span> : '‚Äî'}</td>
                  <td className="p-3 text-center">{c.dnfFlag ? <span className="text-red-400">üö´ DNF</span> : c.monitored ? <span className="text-emerald-400">üì°</span> : '‚Äî'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <div className="grid grid-cols-3 gap-4">
          {filtered.slice(0, 9).map(c => (
            <div key={c.id} className={`${t.bg2} p-4 rounded-2xl border ${t.border} ${c.dnfFlag ? 'border-red-500/50 opacity-60' : ''}`}>
              <div className="flex items-center justify-between mb-2">
                <h3 className="font-bold">{c.name}</h3>
                {c.dnfFlag && <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded">DNF</span>}
                {c.taxExempt && <span className="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded">{c.taxType}</span>}
              </div>
              <p className={`text-sm ${t.muted}`}>{c.address}</p>
              
              <div className={`${t.bg3} p-3 rounded-xl mt-3`}>
                <div className="flex justify-between text-sm">
                  <span>Tank: {c.tank}g ({c.tankOwnership === 'company' ? 'COT' : 'Cust'})</span>
                  <span className={getTankColor(c.level) + ' px-2 rounded'}>{c.level}%</span>
                </div>
              </div>

              {/* Pre-Buy Balance */}
              {c.preBuyRemaining > 0 && (
                <div className="bg-sky-500/20 p-3 rounded-xl mt-2">
                  <div className="flex justify-between text-sm">
                    <span className="text-sky-400">Pre-Buy Balance</span>
                    <span className="font-bold text-sky-400">{c.preBuyRemaining} / {c.preBuyGallons} gal</span>
                  </div>
                  <p className={`text-xs ${t.muted}`}>@ ${c.preBuyPrice}/gal</p>
                </div>
              )}

              {/* Split Billing Indicator */}
              {c.paymentMethod === 'Split' && (
                <div className="bg-purple-500/20 p-3 rounded-xl mt-2">
                  <p className="text-sm text-purple-400 font-bold">Split Billing</p>
                  <p className={`text-xs ${t.muted}`}>Landlord {c.splitLandlord}% / Tenant {c.splitTenant}%</p>
                </div>
              )}

              {/* Harvest Mode */}
              {c.harvestMode && (
                <div className="bg-amber-500/20 p-3 rounded-xl mt-2">
                  <p className="text-sm text-amber-400 font-bold">üåæ Harvest Mode Active</p>
                  <p className={`text-xs ${t.muted}`}>K-Factor overridden - 3 day cycle</p>
                </div>
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// ============================================
// TANK VIEW
// ============================================
function TankView({ t, customers }) {
  const clusters = [...new Set(customers.map(c => c.cluster))];
  
  return (
    <div>
      <h2 className="text-xl font-bold mb-4">Tank Monitoring</h2>
      <div className="grid grid-cols-4 gap-4">
        {clusters.map(cluster => {
          const clusterCustomers = customers.filter(c => c.cluster === cluster);
          const critical = clusterCustomers.filter(c => c.level < 20).length;
          return (
            <div key={cluster} className={`${t.bg2} p-4 rounded-2xl border ${t.border}`}>
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-bold">{cluster}</h3>
                {critical > 0 && <span className="bg-red-500 text-white text-xs px-2 py-1 rounded-full">{critical} critical</span>}
              </div>
              <p className={`text-sm ${t.muted} mb-3`}>{clusterCustomers.length} tanks</p>
              <button className="w-full bg-orange-500 text-slate-900 py-2 rounded-xl font-bold text-sm">+ Add All to Route</button>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// ============================================
// INVOICING VIEW
// ============================================
function InvoicingView({ t }) {
  return (
    <div>
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-bold">Invoicing</h2>
        <button className="bg-orange-500 text-slate-900 px-4 py-2 rounded-xl font-bold">üìÑ Batch Print All (47)</button>
      </div>
      <div className={`${t.bg2} p-6 rounded-2xl border ${t.border}`}>
        <p className={t.muted}>Invoice management, batch operations, and QuickBooks sync.</p>
      </div>
    </div>
  );
}

// ============================================
// REPORTS VIEW - Leaderboard Toggle
// ============================================
function ReportsView({ t, showLeaderboard, setShowLeaderboard }) {
  return (
    <div>
      <h2 className="text-xl font-bold mb-4">Reports</h2>
      
      {/* Leaderboard Toggle - Acquired GM's feedback */}
      <div className={`${t.bg2} p-4 rounded-2xl border ${t.border} mb-4`}>
        <div className="flex items-center justify-between">
          <div>
            <h3 className="font-bold">Driver Leaderboard Visibility</h3>
            <p className={`text-sm ${t.muted}`}>Control whether drivers see each other's rankings</p>
          </div>
          <button onClick={() => setShowLeaderboard(!showLeaderboard)}
            className={`px-4 py-2 rounded-xl font-bold ${showLeaderboard ? 'bg-emerald-500 text-white' : 'bg-slate-600'}`}>
            {showLeaderboard ? 'Visible to All' : 'Managers Only'}
          </button>
        </div>
      </div>

      <div className="grid grid-cols-3 gap-4">
        {['Gallons by Driver', 'Surcharge Capture', 'Route Efficiency', 'Revenue by Branch', 'K-Factor Accuracy', 'Customer Churn'].map(report => (
          <div key={report} className={`${t.bg2} p-4 rounded-2xl border ${t.border} cursor-pointer hover:border-orange-500/50`}>
            <h3 className="font-bold">{report}</h3>
            <p className={`text-sm ${t.muted} mt-1`}>Click to view</p>
          </div>
        ))}
      </div>
    </div>
  );
}

// ============================================
// HQ DASHBOARD - Aggregator View
// ============================================
function HQDashboard({ t, branches }) {
  const totalTrucks = branches.reduce((sum, b) => sum + b.trucks, 0);
  const totalRevenue = branches.reduce((sum, b) => sum + b.revenue, 0);
  const totalTarget = branches.reduce((sum, b) => sum + b.target, 0);
  
  return (
    <div>
      <h2 className="text-xl font-bold mb-4">Headquarters Dashboard</h2>
      
      {/* Rollup Stats */}
      <div className="grid grid-cols-4 gap-4 mb-6">
        <div className={`${t.bg2} p-4 rounded-2xl border ${t.border}`}>
          <p className={t.muted}>Total Trucks</p>
          <p className="text-3xl font-bold">{totalTrucks}</p>
        </div>
        <div className={`${t.bg2} p-4 rounded-2xl border ${t.border}`}>
          <p className={t.muted}>Total Customers</p>
          <p className="text-3xl font-bold">{branches.reduce((sum, b) => sum + b.customers, 0).toLocaleString()}</p>
        </div>
        <div className={`${t.bg2} p-4 rounded-2xl border ${t.border}`}>
          <p className={t.muted}>YTD Revenue</p>
          <p className="text-3xl font-bold text-emerald-400">${(totalRevenue / 1000000).toFixed(1)}M</p>
        </div>
        <div className={`${t.bg2} p-4 rounded-2xl border ${t.border}`}>
          <p className={t.muted}>vs Target</p>
          <p className="text-3xl font-bold">{((totalRevenue / totalTarget) * 100).toFixed(0)}%</p>
        </div>
      </div>

      {/* Branch Performance */}
      <div className={`${t.bg2} rounded-2xl border ${t.border} overflow-hidden`}>
        <table className="w-full">
          <thead className={t.bg3}>
            <tr>
              <th className="text-left p-4">Branch</th>
              <th className="text-center p-4">Trucks</th>
              <th className="text-center p-4">Customers</th>
              <th className="text-right p-4">Revenue</th>
              <th className="text-right p-4">Target</th>
              <th className="text-right p-4">Attainment</th>
            </tr>
          </thead>
          <tbody>
            {branches.map(b => {
              const pct = (b.revenue / b.target) * 100;
              return (
                <tr key={b.id} className={`border-t ${t.border} hover:${t.bg3}`}>
                  <td className="p-4 font-bold">{b.name}</td>
                  <td className="p-4 text-center">{b.trucks}</td>
                  <td className="p-4 text-center">{b.customers.toLocaleString()}</td>
                  <td className="p-4 text-right font-mono">${(b.revenue / 1000).toFixed(0)}K</td>
                  <td className="p-4 text-right font-mono">${(b.target / 1000).toFixed(0)}K</td>
                  <td className={`p-4 text-right font-bold ${pct >= 100 ? 'text-emerald-400' : pct >= 80 ? 'text-amber-400' : 'text-red-400'}`}>
                    {pct.toFixed(0)}%
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// ============================================
// PRICING MODAL - Interactive Configurator
// ============================================
function PricingModal({ t, onClose, tier, setTier, trucks, setTrucks, addons, setAddons, calcPrice }) {
  const prices = calcPrice();
  
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 overflow-y-auto">
      <div className={`${t.bg2} rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto`}>
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-2xl font-bold">üí∞ Build Your Package</h2>
          <button onClick={onClose} className={`${t.bg3} px-4 py-2 rounded-xl`}>‚úï Close</button>
        </div>

        {/* Tier Selection */}
        <div className="grid grid-cols-3 gap-4 mb-6">
          {Object.entries(PRICING_TIERS).map(([key, t2]) => (
            <div key={key} onClick={() => setTier(key)}
              className={`p-4 rounded-2xl border-2 cursor-pointer transition-all ${tier === key ? 'border-orange-500 bg-orange-500/10' : `${t.border} hover:border-orange-500/50`}`}>
              <h3 className={`text-xl font-bold ${tier === key ? 'text-orange-500' : ''}`}>{t2.name}</h3>
              <p className="text-3xl font-bold mt-2">${t2.setup.toLocaleString()}</p>
              <p className={t.muted}>setup</p>
              <p className="text-xl font-bold mt-2">${t2.perTruck}<span className="text-sm font-normal">/truck/mo</span></p>
              <ul className="mt-4 space-y-1">
                {t2.features.slice(0, 4).map((f, i) => (
                  <li key={i} className="text-sm flex items-center gap-2">
                    <span className="text-emerald-400">‚úì</span>{f}
                  </li>
                ))}
                {t2.features.length > 4 && <li className={`text-sm ${t.muted}`}>+{t2.features.length - 4} more...</li>}
              </ul>
            </div>
          ))}
        </div>

        {/* Truck Count */}
        <div className={`${t.bg3} p-4 rounded-xl mb-6`}>
          <label className="font-bold block mb-2">How many trucks?</label>
          <input type="range" min="1" max="50" value={trucks} onChange={(e) => setTrucks(parseInt(e.target.value))}
            className="w-full" />
          <div className="flex justify-between mt-2">
            <span>1</span>
            <span className="text-2xl font-bold text-orange-500">{trucks} trucks</span>
            <span>50+</span>
          </div>
        </div>

        {/* Add-ons */}
        <div className="mb-6">
          <h3 className="font-bold mb-3">Add-On Packs</h3>
          <div className="grid grid-cols-2 gap-4">
            {Object.entries(ADDONS).map(([key, addon]) => (
              <div key={key} onClick={() => setAddons(prev => prev.includes(key) ? prev.filter(a => a !== key) : [...prev, key])}
                className={`p-4 rounded-xl border-2 cursor-pointer ${addons.includes(key) ? 'border-emerald-500 bg-emerald-500/10' : `${t.border}`}`}>
                <div className="flex items-center justify-between">
                  <span className="font-bold">{addon.name}</span>
                  <span className="font-bold text-emerald-400">+${addon.price}/truck</span>
                </div>
                <p className={`text-sm ${t.muted} mt-1`}>{addon.desc}</p>
              </div>
            ))}
          </div>
        </div>

        {/* Price Summary */}
        <div className={`${t.bg3} p-6 rounded-xl`}>
          <h3 className="font-bold text-lg mb-4">Your Investment</h3>
          <div className="space-y-2">
            <div className="flex justify-between">
              <span>Setup ({PRICING_TIERS[tier].name})</span>
              <span className="font-mono">${prices.setup.toLocaleString()}</span>
            </div>
            <div className="flex justify-between">
              <span>Monthly ({trucks} trucks √ó ${PRICING_TIERS[tier].perTruck + addons.reduce((s, a) => s + ADDONS[a].price, 0)})</span>
              <span className="font-mono">${prices.monthly.toLocaleString()}/mo</span>
            </div>
            <hr className={t.border} />
            <div className="flex justify-between text-lg">
              <span className="font-bold">Year 1 Total</span>
              <span className="font-bold text-orange-500">${prices.year1.toLocaleString()}</span>
            </div>
            <div className="flex justify-between">
              <span>Year 2+ (recurring)</span>
              <span className="font-mono text-emerald-400">${prices.year2.toLocaleString()}/yr</span>
            </div>
          </div>

          {/* ROI Callout */}
          <div className="mt-4 p-4 bg-emerald-500/20 rounded-xl">
            <p className="text-emerald-400 font-bold">üí° Potential ROI</p>
            <p className="text-sm mt-1">Average {trucks}-truck operation recovers <span className="font-bold">${(trucks * 8000).toLocaleString()}/year</span> in missed surcharges alone.</p>
          </div>
        </div>

        <button className="w-full mt-6 bg-orange-500 text-slate-900 p-4 rounded-xl font-bold text-lg">
          üìû Schedule Demo
        </button>
      </div>
    </div>
  );
}

// ============================================
// ARCHIVE MODAL - Enterprise Refugee
// ============================================
function ArchiveModal({ t, onClose }) {
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className={`${t.bg2} rounded-2xl p-6 max-w-2xl w-full`}>
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold">üìú Delivery History Archive</h2>
          <button onClick={onClose} className={`${t.bg3} px-4 py-2 rounded-xl`}>‚úï Close</button>
        </div>
        <p className={`${t.muted} mb-4`}>Full historical records imported from legacy system</p>
        
        <div className={`${t.bg3} rounded-xl overflow-hidden`}>
          <table className="w-full text-sm">
            <thead className={t.bg}>
              <tr>
                <th className="text-left p-3">Date</th>
                <th className="text-left p-3">Customer</th>
                <th className="text-right p-3">Gallons</th>
                <th className="text-right p-3">Price</th>
                <th className="text-right p-3">Total</th>
              </tr>
            </thead>
            <tbody>
              {ARCHIVE.map(a => (
                <tr key={a.id} className={`border-t ${t.border}`}>
                  <td className="p-3">{a.date}</td>
                  <td className="p-3 font-semibold">{a.customer}</td>
                  <td className="p-3 text-right font-mono">{a.gallons}</td>
                  <td className="p-3 text-right font-mono">${a.price}</td>
                  <td className="p-3 text-right font-mono">${a.total.toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        
        <p className={`text-xs ${t.muted} mt-4`}>Showing records back to 2020. Full archive available in CSV export.</p>
      </div>
    </div>
  );
}

// ============================================
// FRESH START MODAL - New Entrant
// ============================================
function FreshStartModal({ t, onClose }) {
  const [step, setStep] = useState(1);
  
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className={`${t.bg2} rounded-2xl p-6 max-w-md w-full`}>
        <h2 className="text-xl font-bold mb-4">üöÄ Fresh Start Setup</h2>
        <p className={t.muted}>No data to migrate? No problem. Let's get you delivering today.</p>
        
        <div className="mt-6 space-y-4">
          <div className={`${step >= 1 ? 'opacity-100' : 'opacity-50'} ${t.bg3} p-4 rounded-xl`}>
            <p className="font-bold">Step 1: Company Info</p>
            <input placeholder="Company Name" className={`w-full ${t.bg} rounded-lg p-3 mt-2`} />
          </div>
          <div className={`${step >= 2 ? 'opacity-100' : 'opacity-50'} ${t.bg3} p-4 rounded-xl`}>
            <p className="font-bold">Step 2: First Truck</p>
            <input placeholder="Truck ID (e.g., T-01)" className={`w-full ${t.bg} rounded-lg p-3 mt-2`} />
          </div>
          <div className={`${step >= 3 ? 'opacity-100' : 'opacity-50'} ${t.bg3} p-4 rounded-xl`}>
            <p className="font-bold">Step 3: Default Pricing</p>
            <input placeholder="Price per gallon (e.g., 2.55)" className={`w-full ${t.bg} rounded-lg p-3 mt-2`} />
          </div>
        </div>

        <button className="w-full mt-6 bg-emerald-500 text-white p-4 rounded-xl font-bold">
          ‚úì Start Delivering
        </button>
        <button onClick={onClose} className={`w-full mt-2 ${t.bg3} p-3 rounded-xl`}>Cancel</button>
      </div>
    </div>
  );
}

// ============================================
// PORTAL MODAL - Customer View
// ============================================
function PortalModal({ t, onClose }) {
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className={`${t.bg2} rounded-2xl p-6 max-w-sm w-full`}>
        <h2 className="text-xl font-bold mb-4">üìç Track Your Delivery</h2>
        <div className={`${t.bg3} p-4 rounded-xl mb-4`}>
          <div className="flex items-center gap-3 mb-3">
            <div className="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center text-xl">üöõ</div>
            <div>
              <p className="font-bold">Mike S.</p>
              <p className={`text-sm ${t.muted}`}>Your driver</p>
            </div>
          </div>
          <div className="text-center">
            <p className="text-4xl font-bold text-emerald-400">8 min</p>
            <p className={t.muted}>away</p>
          </div>
        </div>
        <div className="space-y-2">
          {['Order placed', 'Driver assigned', 'En route', 'Arriving soon'].map((step, i) => (
            <div key={step} className="flex items-center gap-3">
              <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${i <= 2 ? 'bg-emerald-500 text-white' : t.bg3}`}>
                {i <= 2 ? '‚úì' : i + 1}
              </div>
              <span className={i <= 2 ? 'font-semibold' : t.muted}>{step}</span>
            </div>
          ))}
        </div>
        <button onClick={onClose} className={`w-full mt-6 ${t.bg3} p-3 rounded-xl`}>Close</button>
      </div>
    </div>
  );
}

// Render the app
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(PropaneV4));
  </script>
  
  <!-- CTA Banner -->
  <div id="demo-banner" style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(to right, #f97316, #ea580c); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; z-index: 9999;">
    <div style="color: white;">
      <strong>This is an interactive demo.</strong> 
      <span style="opacity: 0.9;">See how it works for your operation.</span>
    </div>
    <div style="display: flex; gap: 12px; align-items: center;">
      <a href="https://resultantai.com/propane" style="color: white; text-decoration: underline; font-size: 14px;">Learn More</a>
      <a href="https://meetings.hubspot.com/resultantai/propane-demo" 
         style="background: white; color: #ea580c; padding: 8px 20px; border-radius: 8px; font-weight: bold; text-decoration: none;">
        Book a Demo
      </a>
      <button onclick="document.getElementById('demo-banner').style.display='none'" 
              style="background: none; border: none; color: white; cursor: pointer; font-size: 20px; padding: 4px;">
        √ó
      </button>
    </div>
  </div>
</body>
</html>
